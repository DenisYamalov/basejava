<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <title>second test</title>
</head>
<body>

<form method="post" action="resume" enctype="application/x-www-form-urlencoded" id="form">
    <dl>
        <div class="Education companyContainer" id="companyContainer_1">
            <dd>
                <label class="companyName">Наименование организации
                    <input type="text" name="Education: companyName "
                           value="${company.homepage.name}">
                </label>
                <label class="companyUrl">Ссылка
                    <input type="text" name="Education: companyUrl"
                           value="${company.homepage.url}">
                </label>
                <div class="periodContainer">
                    <label>Дата начала
                        <input type="date" name="Education: startDate"
                               value="2018-07-22">
                    </label>
                    <label>Дата завершения
                        <input type="date" name="Education: finishDate"
                               value="2018-07-22">
                    </label>
                    <label>Описание
                        <textarea name="Education: periodDescription" rows="3"
                                  cols="100">${period.description}</textarea>
                    </label>
                </div>
                <button class="add_button add_period_button" type="button">Добавить период
                </button>
            </dd>
        </div>
        <button class="add_button add_education_button" type="button">Добавить организацию</button>
        <div class="Experience companyContainer">
            <dd>
                <label class="companyName">Наименование организации
                    <input type="text" name="Experience: companyName "
                           value="${company.homepage.name}">
                </label>
                <label class="companyUrl">Ссылка
                    <input type="text" name="Experience: companyUrl"
                           value="${company.homepage.url}">
                </label>
                <div class="periodContainer">
                    <label>Дата начала
                        <input type="date" name="Experience: startDate"
                               value="2018-07-22">
                    </label>
                    <label>Дата завершения
                        <input type="date" name="Experience: finishDate"
                               value="2018-07-22">
                    </label>
                    <label>Должность
                        <input type="text" name="Experience: companyObjective"
                               value="${period.title}">
                    </label>
                    <label>Описание
                        <textarea name="Experience: periodDescription" rows="3"
                                  cols="100">${period.description}</textarea>
                    </label>
                </div>
                <div class="periodContainer">
                    <label>Дата начала
                        <input type="date" name="Experience: startDate"
                               value="2018-07-23">
                    </label>
                    <label>Дата завершения
                        <input type="date" name="Experience: finishDate"
                               value="2018-07-23">
                    </label>
                    <label>Должность
                        <input type="text" name="Experience: companyObjective"
                               value="${period.title}2">
                    </label>
                    <label>Описание
                        <textarea name="Experience: periodDescription" rows="3"
                                  cols="100">${period.description}2</textarea>
                    </label>
                </div>
                <button class="add_button add_period_button" type="button">Добавить период
                </button>
            </dd>
        </div>
        <div class="Experience companyContainer">
            <dd>
                <label class="companyName">Наименование организации
                    <input type="text" name="Experience: companyName "
                           value="${company.homepage.name}">
                </label>
                <label class="companyUrl">Ссылка
                    <input type="text" name="Experience: companyUrl"
                           value="${company.homepage.url}">
                </label>
                <div class="periodContainer">
                    <label>Дата начала
                        <input type="date" name="Experience: startDate"
                               value="2018-07-22">
                    </label>
                    <label>Дата завершения
                        <input type="date" name="Experience: finishDate"
                               value="2018-07-22">
                    </label>
                    <label>Должность
                        <input type="text" name="Experience: companyObjective"
                               value="${period.title}">
                    </label>
                    <label>Описание
                        <textarea name="Experience: periodDescription" rows="3"
                                  cols="100">${period.description}</textarea>
                    </label>
                </div>
                <button class="add_button add_period_button" type="button">Добавить период
                </button>
            </dd>
        </div>
        <button class="add_button add_education_button" type="button">Добавить организацию</button>
    </dl>
    <br>
    <hr>
    <button type="submit">Сохранить</button>
    <button type="reset" onclick="window.history.back()">Отменить</button>
</form>

<script>
    $(document).ready(function() {
        // Attach click event handler to.add_period_button buttons
        $(document).on('click', '.add_period_button', function(e) {
            e.preventDefault(); // Prevent the default action of the button

            // Find the closest.companyContainer and the last.periodContainer within it
            var $closestCompanyContainer = $(this).closest('.companyContainer');
            var $lastPeriodContainer = $closestCompanyContainer.find('.periodContainer:last');

            // Clone the last.periodContainer
            var $newPeriodContainer = $lastPeriodContainer.clone();

            // Append the cloned.periodContainer right after the last one
            $lastPeriodContainer.after($newPeriodContainer);

            // Optionally, clear the inputs in the new periodContainer
            $newPeriodContainer.find('input, textarea').val('');
        });
    });

    const form = document.querySelector("#form");

    async function sendData() {
        // Select all company containers
        const educationContainers = document.querySelectorAll('.Education.companyContainer');
        const experienceContainers = document.querySelectorAll('.Experience.companyContainer');

        // Initialize arrays to hold counts
        let educationPeriodCounts = [];
        let experiencePeriodCounts = [];

        // Function to count periods in a single container
        function countPeriods(container) {
            return container.querySelectorAll('.periodContainer').length;
        }

        // Count periods in each education container
        educationContainers.forEach((container) => {
            const count = countPeriods(container);
            educationPeriodCounts.push(count);
        });

        // Count periods in each experience container
        experienceContainers.forEach((container) => {
            const count = countPeriods(container);
            experiencePeriodCounts.push(count);
        });

        // Associate the FormData object with the form element
        const formData = new FormData(form);
        formData.append("educationPeriodCounts", educationPeriodCounts);
        formData.append("experiencePeriodCounts", experiencePeriodCounts);

        try {
            const response = await fetch("https://example.org/post", {
                method: "POST",
                // Set the FormData instance as the request body
                body: formData,
            });
            console.log(await response.json());
            console.log(educationCompanies.length)
        } catch (e) {
            console.error(e);
        }
    }

    // Take over form submission
    form.addEventListener("submit", (event) => {
        event.preventDefault();
        sendData();
    });
</script>
</body>
</html>